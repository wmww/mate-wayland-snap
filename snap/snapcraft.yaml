name: mate-wayland
version: mate-wayland
version-script: |
  LANG=C apt-cache policy libmircore1 | sed -rne 's/^\s+Candidate:\s+([^-]*)-.+$/egmde'$(git --git-dir=parts/egmde/src/.git rev-list --count HEAD)'-mir\1/p'
summary: A prototype for the MATE desktop running on Wayland with Mir
description: A prototype for the MATE desktop running on Wayland with Mir
confinement: classic
grade: devel
base: core18

apps:
  mate-wayland:
    command: bin/mate-wayland.launcher
    environment:
      # Prep for Mir
      MIR_CLIENT_PLATFORM_PATH: ${SNAP}/usr/lib/${SNAPCRAFT_ARCH_TRIPLET}/mir/client-platform
      MIR_SERVER_PLATFORM_PATH: ${SNAP}/usr/lib/${SNAPCRAFT_ARCH_TRIPLET}/mir/server-platform
      __EGL_VENDOR_LIBRARY_DIRS: $SNAP/etc/glvnd/egl_vendor.d:$SNAP/usr/share/glvnd/egl_vendor.d
      EGMDE_LAUNCH_PREFIX: "env -u __EGL_VENDOR_LIBRARY_DIRS --"

parts:
  mir-git:
    plugin: cmake
    source: https://github.com/MirServer/mir.git
    # Override the build process so we can install Mir in /usr/local
    # Generated *.pc files have incorrect include paths when snapcraft is allowed to install in /root/stage
    override-build: |
        cmake ../src \
            -DCMAKE_INSTALL_PREFIX=/usr \
            -DMIR_ENABLE_TESTS=OFF \
            -DMIR_PLATFORM='mesa-kms;mesa-x11'
        cmake --build . -- -j10
        cmake --build . --target install
        DESTDIR=$SNAPCRAFT_PART_INSTALL cmake --build . --target install
    # TODO Add a prime section so development headers and such don't get primed
    build-packages:
      - build-essential
      - xsltproc
      - libboost-dev
      - libboost-date-time-dev
      - libboost-program-options-dev
      - libboost-system-dev
      - libboost-filesystem-dev
      - libboost-iostreams-dev
      - protobuf-compiler
      - libdrm-dev
      - libegl1-mesa-dev
      - libgles2-mesa-dev
      - libgl1-mesa-dev
      - libgbm-dev
      - libglm-dev
      - libprotobuf-dev
      - libgoogle-glog-dev
      - liblttng-ust-dev
      - libxkbcommon-dev
      - libumockdev-dev
      - umockdev
      - libudev-dev
      - libgtest-dev
      - google-mock
      - libxml++2.6-dev
      - libglib2.0-dev
      - libfreetype6-dev
      - libevdev-dev
      - libinput-dev
      - uuid-dev
      - python3
      - nettle-dev
      - libcapnp-dev
      - capnproto
      - libepoxy-dev
      - python3-pil
      - libxcb-composite0-dev
      - libxcursor-dev
      - libyaml-cpp-dev
    stage-packages:
      - libdrm2
      - libegl1-mesa
      - libgbm1
      - libgles2
      - libwayland-server0
      - libxcursor1
      - libxfixes3
      - libxrender1
      - libboost-iostreams1.65.1
      - libfreetype6
      - libgflags2.2
      - libgoogle-glog0v5
      - liblttng-ust0
      - libunwind8
      - liburcu6
      - libwayland-egl1-mesa
      - libxcb-composite0
      - libxcb-render0
      - libyaml-cpp0.5v5
      - libcapnp-0.6.1
      - libboost-program-options1.65.1
      - libevdev-dev
      - libgudev-1.0-0
      - libinput10
      - libmtdev1
      - libprotobuf-lite10
      - libwacom2
      - libxkbcommon0

  egmde:
    after: [mir-git]
    plugin: cmake
    source: https://github.com/AlanGriffiths/egmde.git
    build-packages:
      - pkg-config
      - libboost-filesystem-dev
      - libfreetype6-dev
    stage-packages:
      - libboost-filesystem1.65.1

  launcher:
    plugin: dump
    source: glue
    organize:
      mate-wayland.launcher: bin/
      mate-wayland.desktop: bin/

  mesa:
    plugin: nil
    stage-packages:
    - libgl1-mesa-dri
